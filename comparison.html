<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="stylesheet" href="style.css">
		<title>Demo Page - Investigating Modality Contribution in Audio LLMs for Music</title>
	</head>

	<body>
		<script src="https://d3js.org/d3.v7.min.js"></script>
		<script src="visualization.js"></script>

		<h1 id="qid">QID </h1>
		<div id="qwen-fs-container">

		<div id="qwen-zs-container">

		<div id="mu-fs-container">

		<div id="mu-zs-container">

		<script>
				const paramsStr = window.location.search;
				console.log(paramsStr)
				const searchParams = new URLSearchParams(paramsStr);
				const qid = searchParams.get("qid");
				document.getElementById("qid").innerHTML = qid

        // --- Main function to initialize the demo page ---
        async function initPage() {
            const mainContainer = document.getElementById("qwen-fs-container");

            // --- 1. DEFINE THE LIST OF DATA FILES TO LOAD ---
            // Place your JSON files in a 'data' folder next to your index.html
            const dataFiles = [
                'data/719_qwen_fs.json',
                // 'data/sample2.json',
                // 'data/sample3.json'
                // Add as many files as you want here
            ];

            // --- 2. DYNAMICALLY CREATE HTML CONTAINERS ---
            // We create a placeholder for each plot that will be populated later.
            dataFiles.forEach((file, index) => {
                const plotId = `plot-${index}`;

                const plotContainer = document.createElement('div');
                plotContainer.className = 'plot-container';
                plotContainer.innerHTML = `
                    <h3 id="${plotId}-title">Loading...</h3>
                    <div id="${plotId}-text" class="text-container"></div>
                    <div id="${plotId}-audio"></div>
                `;
                mainContainer.appendChild(plotContainer);
            });

            // --- 3. LOAD ALL DATA FILES ASYNCHRONOUSLY ---
            try {
                // Promise.all waits for all fetch requests to complete
                const allData = await Promise.all(
                    dataFiles.map(file => fetch(file).then(response => response.json()))
                );

                console.log("All data loaded successfully:", allData);

                // --- 4. RENDER EACH VISUALIZATION ---
                allData.forEach((data, index) => {
                    const plotId = `plot-${index}`;

                    // Update the title from the loaded data
                    const titleEl = document.getElementById(`${plotId}-title`);
                    if (data.title) {
                        titleEl.innerText = data.title;
                    } else {
                        titleEl.innerText = `Example ${index + 1}`;
                    }

                    // Prepare the configuration object for this specific plot
                    const vizConfig = {
                        ...data, // Spread all properties from the JSON file
                        textContainerId: `${plotId}-text`,
                        audioContainerId: `${plotId}-audio`,
                        // Add the onTokenClick callback if you want interactivity
                        // onTokenClick: (token, i) => handleTokenClick(token, i, index)
                    };

										// the default value for audio + text shapley values is the aggregate value. if the user clicks in any text tokens, we then update witht he specific
										if (Array.isArray(vizConfig.question_shapley_values[0])) {
														console.log("aggregate text shapley values for default viz");
														vizConfig.question_shapley_values = data.question_shapley_values.map(d=> d3.sum(d));
													}

										if (Array.isArray(vizConfig.audio_shapley_values[0])) {
														console.log("aggregate audio shapley values for default viz");
														const transposedAudio = d3.transpose(data.audio_shapley_values);
														vizConfig.audio_shapley_values = data.audio_shapley_values.map(d => d3.sum(d));
													}

										// Create the visualization for the current data
										createModalityVisualization(vizConfig);
									});

            } catch (error) {
                console.error("Failed to load data files:", error);
                mainContainer.innerHTML = `<p style="color: red;">Error: Could not load the visualization data. Please check the console and ensure the data files are in the correct location.</p>`;
            }
        }

        // --- (Optional) Interactive Click Handler ---
        // If you need interactivity per-plot, you can extend it like this.
        // For now, we are not using it in the config above.
        /*
        function handleTokenClick(token, tokenIndex, plotIndex) {
            console.log(`Token '${token}' clicked in plot ${plotIndex}`);
            // Here you could fetch new data specifically for this plot and re-render it
            // For example: `fetchDataForToken(token).then(newData => ...)`
        }
        */

        // Start the page initialization process
        initPage();
    </script>
</body>
</html>
